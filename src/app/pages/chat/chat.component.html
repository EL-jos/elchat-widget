<!-- ‚úÖ Canvas UNIQUE, plac√© AVANT les √©crans conditionnels -->
<div class="el-visualizer-container" [class.active]="isVisualizerActive">
    <div class="el-visualizer-placeholder" *ngIf="isVisualizerActive">
        <img src="../../../assets/svg/microphone-voice-recording-svgrepo-com.svg" alt="">
        Enregistrement...
    </div>
    <canvas #visualizerCanvas class="el-visualizer-canvas"></canvas>
</div>

<div class="el-screen el-bot" *ngIf="isChatStarted">
    <div class="el-header">
        <button type="button" class="el-new-chat" routerLink="/conversations">
            Mes conversations
        </button>
        <button type="button" class="el-new-chat" (click)="startNewChat()">
            New chat
        </button>

    </div>
    <div class="el-chat-messages">
        <ng-container *ngFor="let msg of selectedConversation?.messages">
            <div *ngIf="msg.content && msg.id" [ngClass]="{
                 'el-message-bot': msg.role==='bot',
                 'el-message-user': msg.role==='user',
                 'el-loading-message-bot': msg.id==='loading',
                 'el-message': true
               }">
                <ng-container *ngIf="msg.id==='loading'">
                    <img src="../../../assets/svg/loading-black.svg" alt="">
                </ng-container>
                <!-- üîπ Contenu + Bouton TTS pour les messages bot (AJOUTER) -->
                <ng-container *ngIf="msg.id!=='loading'">
                    <p class="el-message-content">{{ msg.content }}</p>
                
                    <!-- Bouton TTS uniquement pour les messages du bot -->
                    <button *ngIf="msg.role === 'bot'" type="button" class="el-btn-tts" [class.playing]="speakingMessageIds.has(msg.id)"
                        (click)="playMessageTTS(msg.id, msg.content)" title="√âcouter le message">
                        <span *ngIf="!speakingMessageIds.has(msg.id)">üîä</span>
                        <span *ngIf="speakingMessageIds.has(msg.id)">‚èπÔ∏è</span>
                    </button>
                </ng-container>
            </div>
        </ng-container>

    </div>

    <form class="el-chat-input-area" (ngSubmit)="onSubmit(chatForm)" #chatForm="ngForm">
        <textarea type="text" class="el-chat-input" placeholder="Type your message here..." [(ngModel)]="messageContent"
            name="message"></textarea>
        <!-- üîπ Bouton Voice (AJOUTER) -->
        <button type="button" class="el-btn-voice" (click)="toggleVoiceInput()"
            [class.listening]="voiceState.isListening" [disabled]="!voiceService.isSupported()"
            title="{{ voiceService.isSupported() ? 'Message vocal' : 'Non support√©' }}">
            <img *ngIf="!voiceState.isListening" src="../../../assets/svg/microphone-voice-recording-svgrepo-com.svg" alt="">
            <img *ngIf="voiceState.isListening" src="../../../assets/svg/stop-button-black-rounded-square-svgrepo-com.svg" alt="">
        </button>
        <button type="submit" class="el-btn-send-message">
            <img src="../../../assets/svg/send-2-svgrepo-com.svg" alt="">
        </button>
    </form>
</div>

<!-- New conversation screen -->
<div class="el-screen el-bot el-new-conversation" *ngIf="!isChatStarted">
    <div class="el-welcom">
        <div><img src="./assets/svg/logo_orange.svg" alt=""></div>
        <h1>New conversation</h1>
        <p>How may I help you?</p>
    </div>
    <form class="el-chat-input-area" (ngSubmit)="onSubmit(chatForm)" #chatForm="ngForm">
        <textarea type="text" class="el-chat-input" placeholder="Type your message here..." [(ngModel)]="messageContent"
            name="message"></textarea>
        <!-- üîπ Bouton Voice (AJOUTER) -->
        <button type="button" class="el-btn-voice" (click)="toggleVoiceInput()"
            [class.listening]="voiceState.isListening" [disabled]="!voiceService.isSupported()"
            title="{{ voiceService.isSupported() ? 'Message vocal' : 'Non support√©' }}">
            <img *ngIf="!voiceState.isListening" src="../../../assets/svg/microphone-voice-recording-svgrepo-com.svg" alt="">
            <img *ngIf="voiceState.isListening" src="../../../assets/svg/stop-button-black-rounded-square-svgrepo-com.svg" alt="">
        </button>

        <button type="submit" class="el-btn-send-message">
            <img src="../../../assets/svg/send-2-svgrepo-com.svg" alt="">
        </button>
    </form>
</div>